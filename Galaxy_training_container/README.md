[![Galaxy version](https://img.shields.io/badge/Galaxy%20version-20.05-blue)](https://github.com/bgruening/docker-galaxy-stable/tree/20.05)

# Creating a new galaxy training container

For an in depth view on the specific steps in the creation of a new tutorial please visit:

- [Creating a new tutorial](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-tutorial/tutorial.html)
- [Defining the technical infrastructure](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-tutorial-technical/tutorial.html)
- [Creating Interactive Galaxy Tours](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-tutorial-tours/tutorial.html)
- [Slides](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-tutorial-slides/slides.html#1)
- [Writing content in Markdown](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-tutorial-content/tutorial.html)

## From idea to a running galaxy container for training

### 1. Create your workflow on a running Galaxy instance

When the Docker image is being built, the necessary tools for the tutorial will be installed from one or multiple `.ga` files in the workflow folder. This  means that tools which are not covered in a workflow, will not be installed. This also means that a container will always contain the correct version of a tool including its dependencies.  Learn more about how you can extract a workflow from a history [here](https://galaxyproject.org/learn/advanced-workflow/extract/). The available tools for galaxy can be found in the [toolshed](https://toolshed.g2.bx.psu.edu/).

### 2. Create a Zenodo record with the input data

Find a good toy dataset and upload it on [Zenodo](https://zenodo.org/).
When the dataset is published, zenodo will generate a Digital Object Identifier (DOI) for your upload. 
> The DOI link will be used in step 4.

### 3. Determine the topic

Each training is related to a topic. All training materials (slides, tutorials, …) related to a topic are found in a dedicated directory (e.g. transcriptomics directory contains the material related to exome sequencing analysis). Please visit [Including a new topic](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-topic/tutorial.html) when the tutorial does not fit within one of the existing topics.

### 4. Genarate the file structure using planemo

#### The file structure

```
├── README.md
├── metadata.yaml
├── images
├── docker
│   ├── Dockerfile
├── slides
│   ├── index.html
├── tutorials
│   ├── tutorial1
│   │   ├── tutorial.md
│   │   ├── slides.html (optional)
│   │   ├── data-library.yaml
│   │   ├── workflows
│   │   │   ├── workflow.ga
│   │   ├── tours
│   │   │   ├── tour.yaml (optional)
```

The `./topics` folder in this repository is a working example topic and can be used as guideline. 

#### Install planemo

`Planemo` can be easily installed using `pip`.  

```
pip install planemo
```
> Be sure that planemo is installed in the correct python version

For more information about planemo visit https://planemo.readthedocs.io

#### Generate the skeleton of your tutorial

Open a terminal, go to the root of the training repository (in this example `./Galaxy_training_container`) and use following command:
From a local workflow file (`.ga`) (generated from a history or built in the workflow editor). 

     ```shell
     $ planemo training_init \
            --topic_name "my-topic" \
            --tutorial_name "my-new-tutorial" \
            --tutorial_title "Title of the tutorial" \
            --workflow "path/to/workflow" \
            --zenodo_link "URL to the Zenodo record"
     ```
Check that a new directory (with your tutorial name) has been generated in the topic folder.\
Fill the remaining metadata and the content of the `tutorial.md`

### 5. Creating the data-library file

The `data-library.yaml` file will be used to load the published dataset from Zenodo. 
   - Copy the DOI link generated by Zenodo 
   - Generate the data-library.yaml file using:
     ```shell
     $ planemo training_fill_data_library \
            --topic_name "my-topic" \
            --tutorial_name "my-new-tutorial" \
            --zenodo_link "URL to the Zenodo record"
     ```
   - Check that the data-library.yaml has been generated
   - Check tha the Zenodo link is in the metadata at the top of the tutorial.md

The `data-library.yaml` will have the following format:
```yaml
---
destination:
  type: library
  name: GTN - Material
  description: Galaxy Training Network Material
  synopsis: Galaxy Training Network Material. See https://training.galaxyproject.org
items:
- name: Title of the topic
  description: Summary of the topic
  items:
  - name: Title of the tutorial
    items:
    - name: 'DOI: 10.5281/zenodo....'
      description: latest
      items:
      - info: https://doi.org/10.5281/zenodo....
        url: https://zenodo.org/api/files/URL/to/the/input/file
        ext: galaxy-datatype
        src: url
```

### 6. Creating a Galaxy Interactive Tour (optional)
A Galaxy Interactive Tour is a way to go through an entire analysis, step by step inside Galaxy in an interactive and explorative way.  To learn more about creating a Galaxy tour you can visit the [dedicated tour training](https://galaxyproject.github.io/training-material/topics/contributing/tutorials/create-new-tutorial-tours/tutorial.html).


### 7. Using Docker to built a Galaxy training container

#### Built the Docker image

Open a terminal, go to the root of the training repository (in this example `./Galaxy_training_container`) and use following command:

```
docker build -t <your_tag> -f topics/<your_topic>/docker/Dockerfile .
```

> Where `<your_tag>` is the name of the image and `<your_topic>` is the name of the topic.

This command will use the `Dockerfile` automatically generated by `planemo training_init` command as recipe to built the corresponding Docker image.

The `Dockerfile` looks like this:

```Dockerfile
FROM bgruening/galaxy-stable:latest

MAINTAINER Galaxy Training Material

ENV GALAXY_CONFIG_BRAND "GTN: Title of the topic"

# copy the tutorials directory for your topic
ADD topics/example_topic/tutorials/ /tutorials/

# install everything for tutorials
ADD bin/docker-install-tutorials.sh /setup-tutorials.sh
ADD bin/mergeyaml.py /mergeyaml.py
RUN /setup-tutorials.sh
```

Where scripts in `./bin` are being used to install the tours, tools, workflows and data-libraries in the latest galaxy docker instance.


#### Running the Docker container

To execute the image, use following command:

```
docker run -p "8080:80" -t <your_tag>
```

> Change the first port if you want to run multiple containers at once.

#### Using the running Galaxy container

Open a webbrowser and go to `http://localhost:8080`.